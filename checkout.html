<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Complete your lab test order - WeightGain" />
    <title>Checkout - WeightGain | Science-Backed Hormone Therapy</title>

    <!-- Security Headers -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://js.stripe.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; frame-src https://js.stripe.com; connect-src 'self' https://api.stripe.com;"
    />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-Frame-Options" content="DENY" />
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />

    <link rel="icon" type="image/png" href="logo.png" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="canonical" href="https://weightgain.com/checkout" />
    <meta name="robots" content="noindex, follow" />
    <meta property="og:title" content="Checkout - WeightGain" />
    <meta property="og:description" content="Complete your hormone optimization order" />
    <meta property="og:image" content="https://weightgain.com/og-image.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="styles.css" />

  </head>
  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Header -->
    <header class="header">
      <div class="container">
        <nav class="nav" role="navigation" aria-label="Main navigation">
          <a href="index.html" class="logo">
            <img src="logo.png" alt="WeightGain" class="logo-img" />
            <span class="logo-text">WeightGain</span>
          </a>

          <ul class="nav-links">
            <li><a href="pricing.html" class="nav-link">Pricing</a></li>
            <li><a href="index.html#how-it-works" class="nav-link">How It Works</a></li>
            <li><a href="results.html" class="nav-link">My Results</a></li>
            <li><a href="account.html" class="nav-link">My Account</a></li>
          </ul>

          <div class="nav-actions">
            <a href="index.html" class="btn btn-secondary btn-small">Continue Shopping</a>
          </div>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="checkout">
      <div class="container">
        <!-- Breadcrumbs -->
        <nav class="breadcrumbs" aria-label="Breadcrumb">
          <ol>
            <li><a href="index.html">Home</a></li>
            <li><a href="pricing.html">Plans</a></li>
            <li aria-current="page">Checkout</li>
          </ol>
        </nav>

        <h1>Checkout</h1>

        <!-- Progress Indicator -->
        <div class="checkout-progress" role="navigation" aria-label="Checkout progress">
          <div class="progress-step active" data-step="1">
            <span class="progress-number">1</span>
            <span class="progress-label">Review</span>
          </div>
          <div class="progress-connector active"></div>
          <div class="progress-step" data-step="2">
            <span class="progress-number">2</span>
            <span class="progress-label">Info</span>
          </div>
          <div class="progress-connector"></div>
          <div class="progress-step" data-step="3">
            <span class="progress-number">3</span>
            <span class="progress-label">Payment</span>
          </div>
        </div>


        <div class="checkout__container">
          <!-- Main Form Area -->
          <div class="checkout__main">
            <!-- State Restriction Warning (hidden by default) -->
            <div class="state-warning" id="state-warning" style="display: none">
              <div class="state-warning__title">Service Not Available</div>
              <div class="state-warning__text">
                Unfortunately, direct-to-consumer lab testing is not available in your state due to
                local regulations. Affected states: New York, New Jersey, Hawaii, and Rhode Island.
              </div>
            </div>

            <!-- Empty Cart State -->
            <div class="empty-state" id="empty-cart" style="display: none">
              <svg
                class="empty-state__icon"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                aria-hidden="true"
              >
                <circle cx="9" cy="21" r="1" />
                <circle cx="20" cy="21" r="1" />
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
              </svg>
              <h3 class="empty-state__title">No membership selected</h3>
              <p class="empty-state__description">Get your personalized hormone protocol.</p>
              <a href="pricing.html" class="btn btn-primary">View Membership</a>
            </div>

            <!-- Step 1: Choose Your Plan -->
            <div class="checkout__step" id="step-cart">
              <div class="checkout__step-header">
                <span class="checkout__step-number">1</span>
                <h2 class="checkout__step-title">Choose Your Plan</h2>
              </div>

              <!-- Gender Selection -->
              <div class="plan-option-group">
                <label class="plan-option-label">Select your protocol:</label>
                <div class="plan-option-buttons gender-buttons">
                  <button type="button" class="plan-option-btn gender-btn active" data-gender="male">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" class="plan-option-icon">
                      <circle cx="10" cy="8" r="5"/>
                      <path d="M21 3l-4 4m0-4l4 4M10 13c-5 0-8 2.5-8 5.5V21h16v-2.5c0-3-3-5.5-8-5.5z"/>
                    </svg>
                    <span>Male Protocol</span>
                  </button>
                  <button type="button" class="plan-option-btn gender-btn" data-gender="female">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" class="plan-option-icon">
                      <circle cx="12" cy="7" r="5"/>
                      <path d="M12 14c-5 0-8 2.5-8 5.5V22h16v-2.5c0-3-3-5.5-8-5.5z"/>
                    </svg>
                    <span>Female Protocol</span>
                  </button>
                </div>
              </div>

              <!-- Billing Cycle Selection -->
              <div class="plan-option-group">
                <label class="plan-option-label">Billing:</label>
                <div class="plan-option-buttons">
                  <button type="button" class="plan-option-btn billing-btn active" data-billing="monthly">
                    <span class="plan-option-price">$249</span>
                    <span>/month</span>
                  </button>
                  <button type="button" class="plan-option-btn billing-btn" data-billing="yearly">
                    <span class="plan-option-price">$207</span>
                    <span>/month</span>
                    <span class="plan-option-badge">Save $498</span>
                  </button>
                </div>
              </div>

              <!-- Plan Summary -->
              <div class="plan-summary-card">
                <div class="plan-summary-header">
                  <h3 id="selectedPlanName">Total Optimization - Male Protocol</h3>
                  <span class="plan-summary-price" id="selectedPlanPrice">$249/mo</span>
                </div>
                <ul class="plan-summary-features">
                  <li>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    Comprehensive blood panel
                  </li>
                  <li>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    Personalized hormone protocol
                  </li>
                  <li>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    Monthly medication delivery
                  </li>
                  <li>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    Quarterly monitoring labs
                  </li>
                  <li>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    Unlimited telehealth visits
                  </li>
                  <li>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    90-day money-back guarantee
                  </li>
                </ul>
              </div>
            </div>

            <!-- Step 2: Your Information -->
            <div class="checkout__step" id="step-info">
              <div class="checkout__step-header">
                <span class="checkout__step-number">2</span>
                <h2 class="checkout__step-title">Your Information</h2>
              </div>

              <form id="checkout-form" novalidate>
                <div class="checkout-form-row">
                  <div class="form-group">
                    <label for="firstName" class="form-label form-label--required"
                      >First Name</label
                    >
                    <div class="input-wrapper">
                      <input
                        type="text"
                        id="firstName"
                        name="firstName"
                        class="form-input"
                        required
                        autocomplete="given-name"
                        aria-describedby="firstName-error"
                      />
                      <span class="input-status" aria-hidden="true"></span>
                    </div>
                    <p class="form-error" id="firstName-error" role="alert"></p>
                  </div>

                  <div class="form-group">
                    <label for="lastName" class="form-label form-label--required">Last Name</label>
                    <div class="input-wrapper">
                      <input
                        type="text"
                        id="lastName"
                        name="lastName"
                        class="form-input"
                        required
                        autocomplete="family-name"
                        aria-describedby="lastName-error"
                      />
                      <span class="input-status" aria-hidden="true"></span>
                    </div>
                    <p class="form-error" id="lastName-error" role="alert"></p>
                  </div>
                </div>

                <div class="form-group">
                  <label for="email" class="form-label form-label--required">Email</label>
                  <div class="input-wrapper">
                    <input
                      type="email"
                      id="email"
                      name="email"
                      class="form-input"
                      required
                      autocomplete="email"
                      aria-describedby="email-hint email-error"
                    />
                    <span class="input-status" aria-hidden="true"></span>
                  </div>
                  <p class="form-hint" id="email-hint">
                    We'll send your lab requisition and results here.
                  </p>
                  <p class="form-error" id="email-error" role="alert"></p>
                </div>

                <!-- Lab Prep Info Box -->
                <div class="lab-info-box">
                  <div class="lab-info-header" data-action="toggleLabPrep" style="cursor: pointer;" role="button" tabindex="0">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="var(--brand-primary)" aria-hidden="true">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                    <strong>Lab Visit Preparation</strong>
                    <span class="lab-info-toggle" aria-expanded="false" aria-controls="lab-info-content">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="toggle-icon">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                      </svg>
                    </span>
                  </div>
                  <ul class="lab-info-list collapsed" id="lab-info-content">
                    <li><span class="info-bullet">1</span> Fast 8-12 hours before blood draw (water is OK)</li>
                    <li><span class="info-bullet">2</span> Bring valid photo ID to your lab appointment</li>
                    <li><span class="info-bullet">3</span> Lab requisition emailed within 1 hour of order</li>
                    <li><span class="info-bullet">4</span> Schedule your lab visit within 7 days</li>
                  </ul>
                </div>

                <div class="form-group">
                  <label for="phone" class="form-label form-label--required">Phone</label>
                  <div class="input-wrapper">
                    <input
                      type="tel"
                      id="phone"
                      name="phone"
                      class="form-input"
                      required
                      autocomplete="tel"
                      inputmode="tel"
                      placeholder="(555) 123-4567"
                      aria-describedby="phone-error"
                    />
                    <span class="input-status" aria-hidden="true"></span>
                  </div>
                  <p class="form-error" id="phone-error" role="alert"></p>

                  <!-- Phone Verification -->
                  <div class="phone-verification" id="phone-verification" style="display: none;">
                    <div class="phone-verify-row">
                      <button type="button" class="btn btn-secondary btn-small" id="verify-phone-btn">Verify Phone</button>
                      <span class="phone-verify-status" id="phone-verify-status"></span>
                    </div>
                    <div class="verify-code-input-row" id="verify-code-row" style="display: none;">
                      <input
                        type="text"
                        class="verify-code-input"
                        id="verify-code"
                        placeholder="000000"
                        maxlength="6"
                        inputmode="numeric"
                        autocomplete="one-time-code"
                        aria-label="Verification code"
                      />
                      <button type="button" class="btn btn-primary btn-small" id="confirm-code-btn">Confirm</button>
                    </div>
                    <div id="resend-timer" style="display: none;">
                      <button type="button" class="link-btn" id="resend-code-btn" disabled>Resend code</button>
                      <span id="resend-countdown"></span>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label for="dob" class="form-label form-label--required">Date of Birth</label>
                  <div class="input-wrapper">
                    <input
                      type="date"
                      id="dob"
                      name="dob"
                      class="form-input"
                      required
                      aria-describedby="dob-error"
                    />
                    <span class="input-status" aria-hidden="true"></span>
                  </div>
                  <p class="form-error" id="dob-error" role="alert"></p>
                </div>

                <div class="form-group">
                  <label for="sex" class="form-label form-label--required">Biological Sex</label>
                  <div class="input-wrapper">
                    <select
                      id="sex"
                      name="sex"
                      class="form-input form-select"
                      required
                      aria-describedby="sex-hint sex-error"
                    >
                      <option value="">Select...</option>
                      <option value="male">Male</option>
                      <option value="female">Female</option>
                    </select>
                    <span class="input-status" aria-hidden="true"></span>
                  </div>
                  <p class="form-hint" id="sex-hint">Required for accurate reference ranges.</p>
                  <p class="form-error" id="sex-error" role="alert"></p>
                </div>

                <hr class="checkout-divider" />

                <h3 class="checkout-section-title">Shipping Address</h3>

                <div class="form-group">
                  <label for="address" class="form-label form-label--required"
                    >Street Address</label
                  >
                  <div class="input-wrapper">
                    <input
                      type="text"
                      id="address"
                      name="address"
                      class="form-input"
                      required
                      autocomplete="street-address"
                      aria-describedby="address-error"
                    />
                    <span class="input-status" aria-hidden="true"></span>
                  </div>
                  <p class="form-error" id="address-error" role="alert"></p>
                </div>

                <div class="checkout-address-row">
                  <div class="form-group">
                    <label for="city" class="form-label form-label--required">City</label>
                    <div class="input-wrapper">
                      <input
                        type="text"
                        id="city"
                        name="city"
                        class="form-input"
                        required
                        autocomplete="address-level2"
                        aria-describedby="city-error"
                      />
                      <span class="input-status" aria-hidden="true"></span>
                    </div>
                    <p class="form-error" id="city-error" role="alert"></p>
                  </div>

                  <div class="form-group">
                    <label for="state" class="form-label form-label--required">State</label>
                    <div class="input-wrapper">
                      <select
                        id="state"
                        name="state"
                        class="form-input form-select"
                        required
                        aria-describedby="state-error"
                      >
                        <option value="">Select...</option>
                      </select>
                      <span class="input-status" aria-hidden="true"></span>
                    </div>
                    <p class="form-error" id="state-error" role="alert"></p>
                  </div>

                  <div class="form-group">
                    <label for="zip" class="form-label form-label--required">ZIP Code</label>
                    <div class="input-wrapper">
                      <input
                        type="text"
                        id="zip"
                        name="zip"
                        class="form-input"
                        required
                        autocomplete="postal-code"
                        pattern="[0-9]{5}"
                        inputmode="numeric"
                        maxlength="5"
                        aria-describedby="zip-error"
                      />
                      <span class="input-status" aria-hidden="true"></span>
                    </div>
                    <p class="form-error" id="zip-error" role="alert"></p>
                  </div>
                </div>
              </form>
            </div>

            <!-- Step 3: Payment -->
            <div class="checkout__step" id="step-payment">
              <div class="checkout__step-header">
                <span class="checkout__step-number">3</span>
                <h2 class="checkout__step-title">Payment</h2>
              </div>

              <div class="alert alert--info" style="margin-bottom: var(--space-4)">
                <svg
                  class="alert__icon"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10" />
                  <path d="M12 16v-4M12 8h.01" />
                </svg>
                <span>HSA/FSA cards accepted. Lab tests are typically eligible expenses.</span>
              </div>

              <!-- Secure Payment via Stripe Elements -->
              <div class="form-group">
                <label for="stripe-card-element" class="form-label form-label--required"
                  >Card Details</label
                >
                <div
                  id="stripe-card-element"
                  class="form-input stripe-element-container"
                >
                  <!-- Stripe Elements will mount here -->
                  <noscript>Please enable JavaScript to complete payment.</noscript>
                </div>
                <div
                  id="card-errors"
                  role="alert"
                  class="card-error-message"
                ></div>
                <p class="form-hint form-hint--icon mt-2">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                    <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                  </svg>
                  Your card details are handled securely by Stripe. We never store your card
                  information.
                </p>
              </div>

              <!-- Hidden input for Stripe token -->
              <input type="hidden" id="stripeToken" name="stripeToken" />
              <input type="hidden" name="_csrf" id="csrf-token" />

              <div class="form-group form-group--mt-4">
                <label class="form-check">
                  <input type="checkbox" class="form-check__input" id="terms" required />
                  <span class="form-check__label">
                    I agree to the <a href="terms.html" target="_blank" rel="noopener">Terms of Service</a> and
                    <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy</a>. I understand that lab tests are non-refundable
                    once the requisition is generated.
                  </span>
                </label>
              </div>

              <div class="form-group form-group--mt-4">
                <label class="form-check">
                  <input type="checkbox" class="form-check__input" id="sms-optin" />
                  <span class="form-check__label" style="font-size: 0.85rem;">
                    I agree to receive SMS updates from WeightGain including order confirmations, health tips, and promotions.
                    Consent is not a condition of purchase. Msg &amp; data rates may apply. Msg frequency varies.
                    Reply STOP to cancel, HELP for help.
                    <a href="terms.html" target="_blank" rel="noopener">Terms</a> &amp;
                    <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.
                  </span>
                </label>
              </div>

              <!-- Medical Disclaimer -->
              <div style="background: var(--gray-100); padding: 1rem; border-radius: 8px; border: 1px solid var(--gray-200); margin-top: 1rem;">
                <p style="font-size: 0.85rem; line-height: 1.5; color: var(--text-secondary); margin: 0;">
                  <strong style="color: var(--brand-primary);">Medical Disclaimer:</strong> Our services are not intended to replace the advice of your primary care physician. Lab results and recommendations are for informational purposes. Individual results may vary. We do not diagnose, treat, or cure any disease.
                </p>
              </div>
            </div>

            <!-- Trust Badges -->
            <div class="checkout-trust-badges">
              <div class="checkout-trust-badge">
                <svg
                  viewBox="0 0 24 24"
                  width="20"
                  height="20"
                  fill="none"
                  stroke="#22c55e"
                  stroke-width="2"
                  aria-hidden="true"
                >
                  <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" />
                  <path d="M9 12l2 2 4-4" />
                </svg>
                <span>90-Day Money-Back Guarantee*</span>
              </div>
              <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; text-align: center;">
                *Conditions apply. Lab tests non-refundable once requisition is generated. See Terms for details.
              </p>
              <div class="checkout-trust-badge">
                <svg
                  viewBox="0 0 24 24"
                  width="20"
                  height="20"
                  fill="none"
                  stroke="#D4AF37"
                  stroke-width="2"
                  aria-hidden="true"
                >
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                  <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                </svg>
                <span>Secure Payment</span>
              </div>
              <div class="checkout-trust-badge">
                <svg
                  viewBox="0 0 24 24"
                  width="20"
                  height="20"
                  fill="none"
                  stroke="#3b82f6"
                  stroke-width="2"
                  aria-hidden="true"
                >
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                </svg>
                <span>HIPAA Protected</span>
              </div>
            </div>

            <!-- Submit Button -->
            <button
              type="submit"
              form="checkout-form"
              class="btn btn--primary btn--lg btn--full"
              id="submit-btn"
            >
              <span class="btn-text">Lock In My Gains</span>
              <span class="btn-spinner" style="display: none">
                <svg class="spinner-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                  <circle
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="3"
                    fill="none"
                    stroke-dasharray="31.4 31.4"
                    stroke-linecap="round"
                  />
                </svg>
                Processing...
              </span>
            </button>

          </div>

          <!-- Order Summary Sidebar -->
          <aside class="checkout__sidebar">
            <div class="order-summary">
              <h2 class="order-summary__title">Your Gains</h2>

              <!-- Total Price - Prominent -->
              <div class="order-summary__price-hero">
                <span class="price-label">Total</span>
                <span class="price-value" id="total">$249.00/mo</span>
              </div>

              <div class="order-summary__details">
                <div class="order-summary__row">
                  <span>Plan</span>
                  <span id="plan-name">Total Optimization</span>
                </div>
                <div class="order-summary__row">
                  <span>Billing</span>
                  <span id="billing-cycle">Monthly</span>
                </div>
              </div>

              <!-- Plan Includes - Prominent -->
              <div class="order-summary__includes">
                <h4>Your Plan Includes</h4>
                <ul id="plan-includes" role="list">
                  <li>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    Comprehensive blood panel
                  </li>
                  <li>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    Personalized hormone protocol
                  </li>
                  <li>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    Monthly medication delivery
                  </li>
                  <li>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    Quarterly monitoring labs
                  </li>
                  <li>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    Unlimited telehealth visits
                  </li>
                  <li>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    90-day money-back guarantee
                  </li>
                </ul>
              </div>

              <!-- Trust Badges -->
              <div class="order-summary__trust">
                <span>HIPAA</span>
                <span>|</span>
                <span>Licensed Pharmacy</span>
                <span>|</span>
                <span>Discreet Shipping</span>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer" role="contentinfo">
      <div class="container">
        <div class="footer__bottom" style="border-top: none; margin-top: 0; padding-top: 0">
          <p class="footer__copyright">
            &copy; 2026 WeightGain. All rights reserved.
          </p>
          <div class="footer__legal">
            <a href="#" class="footer__legal-link">Privacy Policy</a>
            <a href="#" class="footer__legal-link">Terms of Service</a>
            <a href="#" class="footer__legal-link">HIPAA Notice</a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Success Modal -->
    <div
      class="modal"
      id="success-modal"
      style="display: none"
      role="dialog"
      aria-labelledby="success-title"
      aria-modal="true"
    >
      <div class="modal__backdrop"></div>
      <div class="modal__content">
        <svg
          width="64"
          height="64"
          viewBox="0 0 24 24"
          fill="none"
          stroke="#22c55e"
          stroke-width="2"
          style="margin: 0 auto 1.5rem"
          aria-hidden="true"
        >
          <circle cx="12" cy="12" r="10" />
          <path d="M9 12l2 2 4-4" />
        </svg>
        <h2 id="success-title" style="margin-bottom: 0.5rem">Welcome to Total Optimization!</h2>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem">
          Your membership is active. Check your email for blood test info - we'll analyze your
          results and build your personalized protocol.
        </p>
        <div
          style="
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
          "
        >
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem">
            Subscription ID
          </p>
          <p style="font-size: 1.5rem; font-weight: 800; color: #d4af37" id="order-number">
            WG-123456
          </p>
        </div>

        <!-- What Happens Next Tracker -->
        <div class="next-steps-tracker">
          <h4 style="font-size: 0.95rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">What Happens Next</h4>
          <div class="next-steps-list">
            <div class="next-step active">
              <div class="step-marker">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="#22c55e" aria-hidden="true"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
              </div>
              <div class="step-content">
                <span class="step-title">Order Confirmed</span>
                <span class="step-time">Just now</span>
              </div>
            </div>
            <div class="next-step pending">
              <div class="step-marker"><span>2</span></div>
              <div class="step-content">
                <span class="step-title">Lab Requisition Sent</span>
                <span class="step-time">Within 1 hour</span>
              </div>
            </div>
            <div class="next-step pending">
              <div class="step-marker"><span>3</span></div>
              <div class="step-content">
                <span class="step-title">Complete Blood Draw</span>
                <span class="step-time">Within 7 days</span>
              </div>
            </div>
            <div class="next-step pending">
              <div class="step-marker"><span>4</span></div>
              <div class="step-content">
                <span class="step-title">Doctor Reviews Results</span>
                <span class="step-time">2-3 business days after lab</span>
              </div>
            </div>
            <div class="next-step pending">
              <div class="step-marker"><span>5</span></div>
              <div class="step-content">
                <span class="step-title">Protocol Ships</span>
                <span class="step-time">Same day after approval</span>
              </div>
            </div>
          </div>
        </div>

        <!-- SMS Confirmation Banner (shown dynamically after SMS is sent) -->
        <div class="sms-confirmation-status" id="sms-confirmation-status" style="display: none;">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="#22c55e" aria-hidden="true">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
          <span>Order confirmation SMS sent to your phone.</span>
        </div>

        <a href="account.html" class="btn btn-primary btn-large" style="width: 100%; margin-top: 1.5rem;"
          >View Your Dashboard</a
        >
      </div>
    </div>

    <!-- Stripe.js for secure payment handling -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Load modules in dependency order -->
    <script src="js/utils.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/plans.js"></script>
    <script src="js/ui.js"></script>
    <script src="app.js"></script>
    <script>
      // Initialize Stripe (use environment config or fallback to placeholder)
      const stripePublishableKey = window.STRIPE_PUBLISHABLE_KEY || "pk_test_placeholder";
      let stripe, cardElement;

      if (typeof Stripe !== "undefined") {
        stripe = Stripe(stripePublishableKey);
        const elements = stripe.elements();

        // Create card element
        cardElement = elements.create("card", {
          style: {
            base: {
              color: "#0f172a",
              fontFamily: "Inter, system-ui, sans-serif",
              fontSmoothing: "antialiased",
              fontSize: "16px",
              "::placeholder": {
                color: "#94a3b8",
              },
            },
            invalid: {
              color: "#ef4444",
              iconColor: "#ef4444",
            },
          },
        });

        // Mount card element when DOM is ready
        document.addEventListener("DOMContentLoaded", function () {
          const cardContainer = document.getElementById("stripe-card-element");
          if (cardContainer) {
            cardElement.mount("#stripe-card-element");

            // Handle card errors
            cardElement.on("change", function (event) {
              const displayError = document.getElementById("card-errors");
              if (event.error) {
                displayError.textContent = event.error.message;
              } else {
                displayError.textContent = "";
              }
            });
          }
        });
      }

      // State dropdown population
      const stateSelect = document.getElementById("state");
      const states = {
        AL: "Alabama",
        AK: "Alaska",
        AZ: "Arizona",
        AR: "Arkansas",
        CA: "California",
        CO: "Colorado",
        CT: "Connecticut",
        DE: "Delaware",
        FL: "Florida",
        GA: "Georgia",
        HI: "Hawaii",
        ID: "Idaho",
        IL: "Illinois",
        IN: "Indiana",
        IA: "Iowa",
        KS: "Kansas",
        KY: "Kentucky",
        LA: "Louisiana",
        ME: "Maine",
        MD: "Maryland",
        MA: "Massachusetts",
        MI: "Michigan",
        MN: "Minnesota",
        MS: "Mississippi",
        MO: "Missouri",
        MT: "Montana",
        NE: "Nebraska",
        NV: "Nevada",
        NH: "New Hampshire",
        NJ: "New Jersey",
        NM: "New Mexico",
        NY: "New York",
        NC: "North Carolina",
        ND: "North Dakota",
        OH: "Ohio",
        OK: "Oklahoma",
        OR: "Oregon",
        PA: "Pennsylvania",
        RI: "Rhode Island",
        SC: "South Carolina",
        SD: "South Dakota",
        TN: "Tennessee",
        TX: "Texas",
        UT: "Utah",
        VT: "Vermont",
        VA: "Virginia",
        WA: "Washington",
        WV: "West Virginia",
        WI: "Wisconsin",
        WY: "Wyoming",
        DC: "District of Columbia",
      };

      Object.entries(states).forEach(([abbr, name]) => {
        const option = document.createElement("option");
        option.value = abbr;
        option.textContent = name;
        stateSelect.appendChild(option);
      });

      // Restricted states check
      const restrictedStates = ["NY", "NJ", "HI", "RI"];
      stateSelect.addEventListener("change", function () {
        const warning = document.getElementById("state-warning");
        const submitBtn = document.getElementById("submit-btn");
        if (restrictedStates.includes(this.value)) {
          warning.style.display = "block";
          submitBtn.disabled = true;
        } else {
          warning.style.display = "none";
          submitBtn.disabled = false;
        }
      });

      // Load cart items
      function loadCart() {
        const cart = JSON.parse(localStorage.getItem("wg_cart")) || [];
        const cartItems = document.getElementById("cart-items");
        const summaryItems = document.getElementById("summary-items");
        const emptyCart = document.getElementById("empty-cart");
        const stepCart = document.getElementById("step-cart");
        const stepInfo = document.getElementById("step-info");
        const stepPayment = document.getElementById("step-payment");
        const submitBtn = document.getElementById("submit-btn");
        const planNameEl = document.getElementById("plan-name");
        const billingCycleEl = document.getElementById("billing-cycle");
        const planIncludesEl = document.getElementById("plan-includes");

        // Debug: log cart contents
        if (window.WeightGainLogger) {
          window.WeightGainLogger.log("Cart contents:", cart);
        }

        if (cart.length === 0) {
          if (emptyCart) emptyCart.style.display = "block";
          if (stepCart) stepCart.style.display = "none";
          if (stepInfo) stepInfo.style.display = "none";
          if (stepPayment) stepPayment.style.display = "none";
          if (submitBtn) submitBtn.style.display = "none";
          return;
        }

        // Render cart items using DOM methods for XSS safety (if element exists)
        if (cartItems) {
          cartItems.textContent = "";

        cart.forEach((item, index) => {
          const isSubscription = item.billingCycle;
          const suffix =
            item.billingCycle === "monthly" ? "/mo" : item.billingCycle === "yearly" ? "/yr" : "";

          const row = document.createElement("div");
          row.style.cssText =
            "padding: var(--space-4) 0; border-bottom: 1px solid var(--border-light);";

          const headerDiv = document.createElement("div");
          headerDiv.style.cssText =
            "display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);";

          const nameDiv = document.createElement("div");
          const h4 = document.createElement("h4");
          h4.style.cssText = "font-size: var(--text-lg); font-weight: var(--font-semibold);";
          h4.textContent = item.name;
          nameDiv.appendChild(h4);

          if (isSubscription) {
            const billingBadge = document.createElement("span");
            billingBadge.style.cssText =
              "font-size: var(--text-sm); color: var(--brand-primary); background: rgba(212, 175, 55, 0.1); padding: 0.25rem 0.75rem; border-radius: 50px; margin-left: 0.5rem;";
            billingBadge.textContent = item.billingLabel;
            nameDiv.appendChild(billingBadge);
          }

          const priceDiv = document.createElement("div");
          priceDiv.style.cssText = "display: flex; align-items: center; gap: 1rem;";

          const priceSpan = document.createElement("span");
          priceSpan.style.cssText =
            "font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--brand-primary);";
          priceSpan.textContent = `$${item.price}${suffix}`;

          const removeBtn = document.createElement("button");
          removeBtn.style.cssText =
            "background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 1.25rem;";
          removeBtn.textContent = "Ã—";
          removeBtn.onclick = () => removeItem(item.id);

          priceDiv.appendChild(priceSpan);
          priceDiv.appendChild(removeBtn);

          headerDiv.appendChild(nameDiv);
          headerDiv.appendChild(priceDiv);
          row.appendChild(headerDiv);

          // Show includes for subscriptions
          if (isSubscription && item.includes) {
            const includesList = document.createElement("ul");
            includesList.style.cssText =
              "display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: var(--text-sm); color: var(--text-secondary);";
            item.includes.forEach((inc) => {
              const li = document.createElement("li");
              li.style.cssText = "display: flex; align-items: center; gap: 0.5rem;";
              li.innerHTML =
                '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
              const span = document.createElement("span");
              span.textContent = inc;
              li.appendChild(span);
              includesList.appendChild(li);
            });
            row.appendChild(includesList);
          }

          cartItems.appendChild(row);
        });
        } // end if (cartItems)

        // Update sidebar with all items
        const firstItem = cart[0];
        const suffix = firstItem.billingCycle === "monthly" ? "/mo" : "";
        if (planNameEl) planNameEl.textContent = cart.map((i) => i.name).join(" + ");
        if (billingCycleEl) billingCycleEl.textContent = "Monthly";

        // Populate includes in sidebar (combine all)
        if (planIncludesEl) {
          planIncludesEl.textContent = "";
          const allIncludes = [...new Set(cart.flatMap((item) => item.includes || []))];
          allIncludes.forEach((inc) => {
            const li = document.createElement("li");
            li.style.cssText =
              "display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);";
            li.innerHTML =
              '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--success-green)" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
            const span = document.createElement("span");
            span.textContent = inc;
            li.appendChild(span);
            planIncludesEl.appendChild(li);
          });
        }

        // Render summary items using DOM methods
        if (summaryItems) {
          summaryItems.textContent = "";
          cart.forEach((item) => {
            const itemSuffix = item.billingCycle === "monthly" ? "/mo" : "";
            const div = document.createElement("div");
            div.className = "order-summary__item";
            const itemNameSpan = document.createElement("span");
            itemNameSpan.className = "order-summary__item-name";
            itemNameSpan.textContent = item.name;
            const itemPriceSpan = document.createElement("span");
            itemPriceSpan.className = "order-summary__item-price";
            itemPriceSpan.textContent = `$${item.price}${itemSuffix}`;
            div.appendChild(itemNameSpan);
            div.appendChild(itemPriceSpan);
            summaryItems.appendChild(div);
          });
        }

        // Calculate total (ensure prices are valid numbers and multiply by quantity)
        const total = cart.reduce(
          (sum, item) => sum + (Number(item.price) || 0) * (item.quantity || 1),
          0
        );
        const hasMonthly = cart.some((item) => item.billingCycle === "monthly");
        const hasYearly = cart.some((item) => item.billingCycle === "yearly");
        const totalEl = document.getElementById("total");
        if (totalEl) {
          totalEl.textContent = `$${total.toFixed(2)}${hasMonthly ? "/mo" : hasYearly ? "/yr" : ""}`;
        }

        // Update billing cycle display
        if (billingCycleEl && cart.length > 0) {
          billingCycleEl.textContent = cart[0].billingLabel || (hasMonthly ? "Monthly" : hasYearly ? "Yearly" : "-");
        }
      }

      function removeItem(id) {
        let cart = JSON.parse(localStorage.getItem("wg_cart")) || [];
        cart = cart.filter((item) => item.id !== id);
        localStorage.setItem("wg_cart", JSON.stringify(cart));
        loadCart();
      }

      // =============================================================================
      // Real-time Form Validation
      // =============================================================================

      const validationRules = {
        firstName: { required: true, minLength: 1, message: "First name is required" },
        lastName: { required: true, minLength: 1, message: "Last name is required" },
        email: {
          required: true,
          pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
          message: "Please enter a valid email address",
        },
        phone: {
          required: true,
          pattern: /^\(\d{3}\) \d{3}-\d{4}$/,
          message: "Please enter a valid phone number",
        },
        dob: { required: true, message: "Date of birth is required" },
        sex: { required: true, message: "Please select your biological sex" },
        address: { required: true, minLength: 3, message: "Street address is required" },
        city: { required: true, minLength: 2, message: "City is required" },
        state: { required: true, message: "Please select your state" },
        zip: {
          required: true,
          pattern: /^\d{5}$/,
          message: "Please enter a valid 5-digit ZIP code",
        },
      };

      function validateField(input) {
        const name = input.name || input.id;
        const rule = validationRules[name];
        if (!rule) return true;

        const value = input.value.trim();
        const errorEl = document.getElementById(`${name}-error`);
        const wrapper = input.closest(".input-wrapper");
        const statusEl = wrapper?.querySelector(".input-status");

        let isValid = true;
        let errorMessage = "";

        // Check required
        if (rule.required && !value) {
          isValid = false;
          errorMessage = rule.message;
        }
        // Check pattern
        else if (rule.pattern && value && !rule.pattern.test(value)) {
          isValid = false;
          errorMessage = rule.message;
        }
        // Check minLength
        else if (rule.minLength && value.length < rule.minLength) {
          isValid = false;
          errorMessage = rule.message;
        }

        // Update UI
        if (errorEl) {
          errorEl.textContent = isValid ? "" : errorMessage;
        }

        input.classList.toggle("is-invalid", !isValid);
        input.classList.toggle("is-valid", isValid && value);

        if (statusEl) {
          if (isValid && value) {
            statusEl.innerHTML =
              '<svg viewBox="0 0 24 24" width="18" height="18" fill="#22c55e"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
          } else if (!isValid) {
            statusEl.innerHTML =
              '<svg viewBox="0 0 24 24" width="18" height="18" fill="#ef4444"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>';
          } else {
            statusEl.innerHTML = "";
          }
        }

        return isValid;
      }

      function validateAllFields() {
        const form = document.getElementById("checkout-form");
        const inputs = form.querySelectorAll("input[required], select[required]");
        let allValid = true;

        inputs.forEach((input) => {
          if (!validateField(input)) {
            allValid = false;
          }
        });

        // Check terms checkbox
        const terms = document.getElementById("terms");
        if (!terms.checked) {
          allValid = false;
        }

        return allValid;
      }

      // Add blur validation to all form fields
      document.querySelectorAll("#checkout-form input, #checkout-form select").forEach((input) => {
        input.addEventListener("blur", () => validateField(input));
        input.addEventListener("input", () => {
          // Clear error on input, but don't show valid until blur
          const errorEl = document.getElementById(`${input.name || input.id}-error`);
          if (errorEl && input.value.trim()) {
            errorEl.textContent = "";
            input.classList.remove("is-invalid");
          }
        });
      });

      // =============================================================================
      // Phone Number Formatting
      // =============================================================================

      const phoneInput = document.getElementById("phone");
      if (phoneInput) {
        phoneInput.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "");

          if (value.length > 10) {
            value = value.slice(0, 10);
          }

          if (value.length >= 6) {
            value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
          } else if (value.length >= 3) {
            value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
          } else if (value.length > 0) {
            value = `(${value}`;
          }

          e.target.value = value;
        });

      }

      // =============================================================================
      // ZIP Code State Detection (Early Warning)
      // =============================================================================

      const zipInput = document.getElementById("zip");
      if (zipInput) {
        zipInput.addEventListener("blur", function () {
          const zip = this.value.trim();
          if (zip.length === 5) {
            // Simple ZIP to state mapping for restricted states
            const restrictedZipPrefixes = {
              // New York
              100: "NY",
              101: "NY",
              102: "NY",
              103: "NY",
              104: "NY",
              105: "NY",
              106: "NY",
              107: "NY",
              108: "NY",
              109: "NY",
              110: "NY",
              111: "NY",
              112: "NY",
              113: "NY",
              114: "NY",
              115: "NY",
              116: "NY",
              117: "NY",
              118: "NY",
              119: "NY",
              120: "NY",
              121: "NY",
              122: "NY",
              123: "NY",
              124: "NY",
              125: "NY",
              126: "NY",
              127: "NY",
              128: "NY",
              129: "NY",
              130: "NY",
              131: "NY",
              132: "NY",
              133: "NY",
              134: "NY",
              135: "NY",
              136: "NY",
              137: "NY",
              138: "NY",
              139: "NY",
              140: "NY",
              141: "NY",
              142: "NY",
              143: "NY",
              144: "NY",
              145: "NY",
              146: "NY",
              147: "NY",
              148: "NY",
              149: "NY",
              // New Jersey
              "070": "NJ",
              "071": "NJ",
              "072": "NJ",
              "073": "NJ",
              "074": "NJ",
              "075": "NJ",
              "076": "NJ",
              "077": "NJ",
              "078": "NJ",
              "079": "NJ",
              "080": "NJ",
              "081": "NJ",
              "082": "NJ",
              "083": "NJ",
              "084": "NJ",
              "085": "NJ",
              "086": "NJ",
              "087": "NJ",
              "088": "NJ",
              "089": "NJ",
              // Hawaii
              967: "HI",
              968: "HI",
              // Rhode Island
              "028": "RI",
              "029": "RI",
            };

            const prefix = zip.substring(0, 3);
            const detectedState = restrictedZipPrefixes[prefix];

            if (detectedState && restrictedStates.includes(detectedState)) {
              const warning = document.getElementById("state-warning");
              const submitBtn = document.getElementById("submit-btn");
              warning.style.display = "block";
              submitBtn.disabled = true;

              // Also set the state dropdown
              const stateSelect = document.getElementById("state");
              if (stateSelect) {
                stateSelect.value = detectedState;
              }
            }
          }
        });
      }

      // =============================================================================
      // Progress Indicator Updates
      // =============================================================================

      function updateProgressIndicator(step) {
        const steps = document.querySelectorAll(".progress-step");
        const connectors = document.querySelectorAll(".progress-connector");

        steps.forEach((stepEl, index) => {
          const stepNum = index + 1;
          if (stepNum < step) {
            stepEl.classList.add("completed");
            stepEl.classList.remove("active");
          } else if (stepNum === step) {
            stepEl.classList.add("active");
            stepEl.classList.remove("completed");
          } else {
            stepEl.classList.remove("active", "completed");
          }
        });

        connectors.forEach((connector, index) => {
          connector.classList.toggle("active", index < step - 1);
        });
      }

      // Track form interactions for progress
      const infoFields = document.querySelectorAll("#step-info input, #step-info select");
      infoFields.forEach((field) => {
        field.addEventListener("focus", () => updateProgressIndicator(2), { once: true });
      });

      const paymentFields = document.querySelectorAll(
        "#step-payment input, #step-payment .form-check__input"
      );
      paymentFields.forEach((field) => {
        field.addEventListener("focus", () => updateProgressIndicator(3), { once: true });
      });

      // =============================================================================
      // Form Submission with Loading State
      // =============================================================================

      document.getElementById("checkout-form").addEventListener("submit", async function (e) {
        e.preventDefault();

        const submitBtn = document.getElementById("submit-btn");
        const btnText = submitBtn.querySelector(".btn-text");
        const btnSpinner = submitBtn.querySelector(".btn-spinner");

        // Validate all fields
        if (!validateAllFields()) {
          // Focus first invalid field
          const firstInvalid = this.querySelector(".is-invalid");
          if (firstInvalid) {
            firstInvalid.focus();
          }
          return;
        }

        if (!document.getElementById("terms").checked) {
          alert("Please agree to the Terms of Service and Privacy Policy.");
          return;
        }

        // Show loading state
        submitBtn.disabled = true;
        if (btnText) btnText.style.display = "none";
        if (btnSpinner) btnSpinner.style.display = "inline-flex";

        try {
          // Create Stripe token (skip in demo mode with placeholder key)
          if (stripe && cardElement && stripePublishableKey !== "pk_test_placeholder") {
            const { token, error } = await stripe.createToken(cardElement);

            if (error) {
              const errorElement = document.getElementById("card-errors");
              errorElement.textContent = error.message;
              submitBtn.disabled = false;
              if (btnText) btnText.style.display = "inline";
              if (btnSpinner) btnSpinner.style.display = "none";
              return;
            }

            // Store token in hidden field (would be sent to server)
            document.getElementById("stripeToken").value = token.id;
          }

          // In production, this would be sent to your server
          // For demo, simulate successful order
          await new Promise((resolve) => setTimeout(resolve, 1500));

          // Generate order number
          const orderNumber = "WG-" + Math.random().toString(36).substr(2, 6).toUpperCase();
          document.getElementById("order-number").textContent = orderNumber;

          // Clear cart
          localStorage.removeItem("wg_cart");

          // Show success modal with focus trap
          const successModal = document.getElementById("success-modal");
          successModal.style.display = "flex";
          successModal.style.cssText = `
          display: flex;
          position: fixed;
          inset: 0;
          z-index: 9999;
          align-items: center;
          justify-content: center;
          padding: var(--space-4);
        `;
          document.querySelector(".modal__backdrop").style.cssText = `
          position: absolute;
          inset: 0;
          background: rgba(0,0,0,0.5);
        `;

          // Focus the modal for accessibility
          const modalContent = successModal.querySelector(".modal__content");
          if (modalContent) {
            modalContent.setAttribute("tabindex", "-1");
            modalContent.focus();
          }
        } catch (err) {
          if (window.WeightGainLogger) {
            window.WeightGainLogger.error("Payment error:", err);
          }
          alert("An error occurred. Please try again.");
          submitBtn.disabled = false;
          if (btnText) btnText.style.display = "inline";
          if (btnSpinner) btnSpinner.style.display = "none";
        }
      });

      // =============================================================================
      // Modal Focus Trapping
      // =============================================================================

      function trapFocus(modal) {
        const focusableElements = modal.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const firstFocusable = focusableElements[0];
        const lastFocusable = focusableElements[focusableElements.length - 1];

        modal.addEventListener("keydown", function (e) {
          if (e.key === "Tab") {
            if (e.shiftKey) {
              if (document.activeElement === firstFocusable) {
                lastFocusable.focus();
                e.preventDefault();
              }
            } else {
              if (document.activeElement === lastFocusable) {
                firstFocusable.focus();
                e.preventDefault();
              }
            }
          }

          if (e.key === "Escape") {
            // Close modal on Escape if it has a close handler
            const closeBtn = modal.querySelector('[data-action="closeModal"]');
            if (closeBtn) closeBtn.click();
          }
        });
      }

      // Apply focus trap to success modal
      const successModal = document.getElementById("success-modal");
      if (successModal) {
        trapFocus(successModal);
      }

      // =============================================================================
      // Plan Selection Handlers
      // =============================================================================

      // Gender selection with localStorage persistence
      document.querySelectorAll('.plan-option-btn[data-gender]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.plan-option-btn[data-gender]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          const gender = this.dataset.gender;

          // Save to localStorage
          localStorage.setItem('wg_selected_gender', gender);

          // Update plan description based on gender
          const planHeader = document.querySelector('.plan-summary-header h3');
          const planFeatures = document.querySelector('.plan-summary-features');

          if (planHeader) {
            planHeader.textContent = gender === 'female' ? 'Total Optimization - Female Protocol' : 'Total Optimization - Male Protocol';
          }

          // Update specific features based on gender
          if (planFeatures) {
            const panelItem = planFeatures.querySelector('li:first-child');
            if (panelItem) {
              panelItem.textContent = gender === 'female'
                ? 'âœ“ Comprehensive female hormone panel'
                : 'âœ“ Comprehensive male hormone panel';
            }

            // Update second item for gender-specific protocol
            const protocolItem = planFeatures.querySelector('li:nth-child(2)');
            if (protocolItem) {
              protocolItem.textContent = gender === 'female'
                ? 'âœ“ Personalized female hormone protocol'
                : 'âœ“ Personalized male hormone protocol';
            }
          }

          // Update cart with gender selection
          let cart = JSON.parse(localStorage.getItem('wg_cart')) || [];
          if (cart.length > 0) {
            cart[0].gender = gender;
            cart[0].name = gender === 'female' ? 'Total Optimization - Female' : 'Total Optimization - Male';
            localStorage.setItem('wg_cart', JSON.stringify(cart));
          }
        });
      });

      // Restore gender selection from localStorage on page load
      const savedGender = localStorage.getItem('wg_selected_gender');
      if (savedGender) {
        const genderBtn = document.querySelector(`.plan-option-btn[data-gender="${savedGender}"]`);
        if (genderBtn) {
          document.querySelectorAll('.plan-option-btn[data-gender]').forEach(b => b.classList.remove('active'));
          genderBtn.classList.add('active');
          genderBtn.click(); // Trigger the update
        }
      }

      // Billing selection
      document.querySelectorAll('.billing-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.billing-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          const billing = this.dataset.billing;
          const priceEl = document.getElementById('selectedPlanPrice');
          const totalEl = document.getElementById('total');

          if (billing === 'monthly') {
            if (priceEl) priceEl.textContent = '$249/mo';
            if (totalEl) totalEl.textContent = '$249.00/mo';
            updateCartBilling('monthly', 249);
          } else {
            if (priceEl) priceEl.textContent = '$207/mo (billed yearly)';
            if (totalEl) totalEl.textContent = '$2,490.00/yr';
            updateCartBilling('yearly', 2490);
          }
        });
      });

      function updateCartBilling(cycle, price) {
        let cart = JSON.parse(localStorage.getItem('wg_cart')) || [];
        if (cart.length > 0) {
          cart[0].billingCycle = cycle;
          cart[0].price = price;
          cart[0].billingLabel = cycle === 'monthly' ? 'Monthly' : 'Yearly (Save $498)';
          localStorage.setItem('wg_cart', JSON.stringify(cart));
        }
      }

      // Initialize
      if (window.WeightGainLogger) {
        window.WeightGainLogger.log(
          "About to call loadCart, localStorage wg_cart:",
          localStorage.getItem("wg_cart")
        );
      }
      loadCart();
      updateProgressIndicator(1);

      // Gender and Billing Toggle Handlers
      let selectedGender = 'male';
      let selectedBilling = 'monthly';

      function updatePlanDisplay() {
        const planName = document.getElementById('selectedPlanName');
        const planPrice = document.getElementById('selectedPlanPrice');
        const sidebarTotal = document.getElementById('total');
        const sidebarBilling = document.getElementById('billing-cycle');

        const genderText = selectedGender === 'male' ? 'Male Protocol' : 'Female Protocol';
        if (planName) planName.textContent = `Total Optimization - ${genderText}`;

        const priceText = selectedBilling === 'monthly' ? '$249/mo' : '$207/mo';
        const billingText = selectedBilling === 'monthly' ? 'Monthly' : 'Annual ($2,490/yr)';

        if (planPrice) planPrice.textContent = priceText;
        if (sidebarTotal) sidebarTotal.textContent = selectedBilling === 'monthly' ? '$249.00/mo' : '$207.50/mo';
        if (sidebarBilling) sidebarBilling.textContent = billingText;
      }

      // Gender toggle
      document.querySelectorAll('.gender-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          selectedGender = this.dataset.gender;
          updatePlanDisplay();
        });
      });

      // Billing toggle
      document.querySelectorAll('.billing-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.billing-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          selectedBilling = this.dataset.billing;
          updatePlanDisplay();
        });
      });

    </script>
  </body>
</html>
